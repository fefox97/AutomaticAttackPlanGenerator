{% extends "layouts/base.html" %}

{% block title %} MACM-{{ macm_data.Component_ID }} {% endblock %}

{% block stylesheets %}
<style>
    table {
        /*table-layout: fixed; /* Mantiene larghezze uniformi */
    }
    td {
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class=" col-12 my-4">
    <form id="save_evaluation" method="POST" action="/save_evaluation">
        {% for threat in threat_data %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">{{ threat.Threat_ID }}: <strong>{{ threat.Threat }}</strong></h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong class="d-block">STRIDE Classification:</strong>
                        <span class="badge bg-secondary">{{ form_data[threat.Threat].stride }}</span>
                    </div>
                    <div>
                        <strong>Description:</strong>
                        <p class="text-muted">{{ threat.Description }}</p>
                    </div>

                    <!-- Combined Likelihood Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Skill Level</th>
                                    <th>Motive</th>
                                    <th>Opportunity</th>
                                    <th>Size</th>
                                    <th>Ease of Discovery</th>
                                    <th>Ease of Exploit</th>
                                    <th>Awareness</th>
                                    <th>Intrusion Detection</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Likelihood</strong></td>
                                    {% for param in ['skill', 'motive', 'opportunity', 'size', 'ease_of_discovery', 'ease_of_exploit', 'awareness', 'intrusion_detection'] %}
                                        <td>
                                            <input type="number" id="{{ param }}_{{ threat.Threat_ID }}" value="{{ form_data[param] or 5 }}"
                                                min="1" max="9" class="form-control likelihood-input"
                                                onchange="calculateLikelihood('{{ threat.Threat_ID }}')">
                                        </td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-light mt-3">
                        <strong>Overall Likelihood:</strong>
                        <input type="text" id="likelihood_{{ threat.Threat_ID }}" class="form-control" readonly>
                    </div>

                    <!-- Impact Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Loss of Confidentiality</th>
                                    <th>Loss of Integrity</th>
                                    <th>Loss of Availability</th>
                                    <th>Loss of Accountability</th>
                                    <th>Financial Damage</th>
                                    <th>Reputation Damage</th>
                                    <th>Non-Compliance</th>
                                    <th>Privacy Violation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Impact</strong></td>
                                    {% for param in ['loss_of_confidentiality', 'loss_of_integrity', 'loss_of_availability', 'loss_of_accountability', 'financialdamage', 'reputationdamage', 'noncompliance', 'privacyviolation'] %}
                                        <td>
                                            <input type="number" id="{{ param }}_{{ threat.Threat_ID }}" value="{{ form_data[threat.Threat][param] or 5 }}"
                                                min="1" max="9" class="form-control impact-input"
                                                onchange="calculateImpact('{{ threat.Threat_ID }}')">
                                        </td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-light mt-3">
                        <div id="impact_{{ threat.Threat_ID }}" class="d-flex justify-content-between"></div>
                    </div>
                </div>
            </div>
        {% endfor %}
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">Save Evaluation</button>
        </div>
    </form>
</div>

{% block javascripts %}
<script type="text/javascript">
    function calculateLikelihood(threatID) {
        var params = ['skill', 'motive', 'opportunity', 'size', 'ease_of_discovery', 'ease_of_exploit', 'awareness', 'intrusion_detection'];
        var sum = 0, count = 0;
        params.forEach(function(param) {
            var value = parseInt(document.getElementById(param + "_" + threatID).value) || 5;
            sum += value; count++;
            setColor(param + "_" + threatID, value);
        });
        var likelihood = sum / count;
        var likelihoodCategory = getCategory(likelihood);
        document.getElementById("likelihood_" + threatID).value = likelihood.toFixed(2) + " (" + likelihoodCategory + ")";
        setColor("likelihood_" + threatID, likelihood);
    }
    function calculateImpact(threatID) {
        var techParams = ['loss_of_confidentiality', 'loss_of_integrity', 'loss_of_availability', 'loss_of_accountability'];
        var busParams = ['financialdamage', 'reputationdamage', 'noncompliance', 'privacyviolation'];
        var techSum = 0, busSum = 0;
        techParams.forEach(param => { techSum += parseInt(document.getElementById(param + "_" + threatID).value) || 5; });
        busParams.forEach(param => { busSum += parseInt(document.getElementById(param + "_" + threatID).value) || 5; });
        var technicalImpact = techSum / techParams.length;
        var businessImpact = busSum / busParams.length;
        var technicalImpactText = technicalImpact.toFixed(2) + " (" + getCategory(technicalImpact) + ")";
        var businessImpactText = businessImpact.toFixed(2) + " (" + getCategory(businessImpact) + ")";
        document.getElementById("impact_" + threatID).innerHTML = `<strong>Technical Impact:</strong> ${technicalImpactText} | <strong>Business Impact:</strong> ${businessImpactText}`;
        setColor("impact_" + threatID, technicalImpact);
        // Calcolare l'impatto tecnico
        var techSum = 0;
        techParams.forEach(function(param) {
            var value = parseInt(document.getElementById(param + "_" + threatID).value) || 5;
            techSum += value;

            // Aggiungi il colore alla cella in base al valore
            setColor(param + "_" + threatID, value);
        });
        // Calcolare l'impatto commerciale
        var busSum = 0;
        busParams.forEach(function(param) {
            var value = parseInt(document.getElementById(param + "_" + threatID).value) || 5;
            busSum += value;

            // Aggiungi il colore alla cella in base al valore
            setColor(param + "_" + threatID, value);
        });
    }
    function getCategory(value) {
        value = parseInt(value);
        if (value >= 8) {
            return "critical";
        } else if (value >= 6) {
            return "high";
        } else if (value >= 4) {
            return "medium";
        } else if (value >= 2) {
            return "low";
        } else {
            return "note";
        }
    }
    function setColor(id, value) {
        var element = document.getElementById(id);
        element.classList.remove("critical", "high", "medium", "low", "note");
        element.classList.add(getCategory(value));
    }
    window.onload = function() {
        {% for threat in threat_data %}
            calculateLikelihood("{{ threat.Threat_ID }}");
            calculateImpact("{{ threat.Threat_ID }}");
        {% endfor %}
    }
</script>
{% endblock %}
{% endblock %}
